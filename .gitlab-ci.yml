variables:
  CMSSW_RELEASE: CMSSW_10_6_18
  CMSSW_SCRAM_ARCH: slc7_amd64_gcc820

image: gitlab-registry.cern.ch/ci-tools/ci-worker:cc7
  
build:
    tags: [cvmfs]
    stage: build
    only:
        - merge_requests
        - master
    script:
        - set +e && source /cvmfs/cms.cern.ch/cmsset_default.sh; set -e
        - shopt -s extglob
        - scramv1 project CMSSW $CMSSW_RELEASE
        - mkdir -p $CMSSW_RELEASE/src/MuonAnalysis/MuonAnalyzer/
        - mv !($CMSSW_RELEASE) $CMSSW_RELEASE/src/MuonAnalysis/MuonAnalyzer/
        - cd $CMSSW_RELEASE/src/
        - eval `scramv1 runtime -sh`
        - scramv1 b -j5
        - bash MuonAnalysis/MuonAnalyzer/ci/tar_cmssw.sh
    artifacts:
        when: on_success
        expire_in: 1 days
        paths: 
            - build.tar.gz



run-aod:
    tags: [ cvmfs ] 
    stage: run
    only:
        - merge_requests
        - master
    script:
        - set +e && source /cvmfs/cms.cern.ch/cmsset_default.sh; set -e
        - shopt -s extglob
        - source ci/untar_cmssw.sh
        - printf $USER_PASS | base64 -d | kinit $USER_NAME
        - xrdcp  root://eosuser.cern.ch//eos/user/c/cmsmupog/www/MuonPOG_CI/04D2156E-EFB0-A54B-BA65-B9A39B30F0DB.root $PWD/
        - cmsRun MuonAnalysis/MuonAnalyzer/test/run_muonAnalyzer_cfg.py inputFiles=file:04D2156E-EFB0-A54B-BA65-B9A39B30F0DB.root globalTag=106X_upgrade2018_realistic_v11_L1v1   isFullAOD=True isMC=True outputFile=output_aod.root
        - mv output_aod.root ../../


    artifacts:
        when: on_success
        expire_in: 5 days
        paths: 
            - output_aod.root

run-miniaod:
    tags: [ cvmfs ] 
    stage: run
    only:
        - merge_requests
        - master
    script:
        - set +e && source /cvmfs/cms.cern.ch/cmsset_default.sh; set -e
        - shopt -s extglob
        - source ci/untar_cmssw.sh
        - printf $USER_PASS | base64 -d | kinit $USER_NAME
        - xrdcp  root://eosuser.cern.ch//eos/user/c/cmsmupog/www/MuonPOG_CI/DD0D06EF-5C77-8147-84F2-779DEB3E0F52.root $PWD/
        - cmsRun MuonAnalysis/MuonAnalyzer/test/run_muonAnalyzer_cfg.py inputFiles=file:DD0D06EF-5C77-8147-84F2-779DEB3E0F52.root globalTag=106X_upgrade2018_realistic_v11_L1v1   isFullAOD=False isMC=True outputFile=output_miniaod.root
        - mv output_miniaod.root ../../


    artifacts:
        when: on_success
        expire_in: 5 days
        paths: 
            - output_miniaod.root

compare-aod:
    tags: [ cvmfs ] 
    stage: compare
    only:
        - merge_requests
        - master
    script:
        - set +e && source /cvmfs/cms.cern.ch/cmsset_default.sh; set -e
        - shopt -s extglob
        - source ci/untar_cmssw.sh
        - printf $USER_PASS | base64 -d | kinit $USER_NAME
        - xrdcp  root://eosuser.cern.ch//eos/user/c/cmsmupog/www/MuonPOG_CI/reference.root $PWD/
        - python ../../ci/compare_with_reference.py reference.root ../../output_aod.root _aod
    artifacts:
        expire_in: 20 days
        when: always
        paths: 
            - residuals_aod.pdf

compare-miniaod:
    tags: [ cvmfs ] 
    stage: compare
    only:
        - merge_requests
        - master
    script:
        - set +e && source /cvmfs/cms.cern.ch/cmsset_default.sh; set -e
        - shopt -s extglob
        - source ci/untar_cmssw.sh
        - printf $USER_PASS | base64 -d | kinit $USER_NAME
        - xrdcp  root://eosuser.cern.ch//eos/user/c/cmsmupog/www/MuonPOG_CI/reference_miniaod.root $PWD/
        - python ../../ci/compare_with_reference.py reference_miniaod.root ../../output_miniaod.root _miniaod
    artifacts:
        expire_in: 20 days
        when: always
        paths: 
            - residuals_miniaod.pdf

stages:
  - build
  - run
  - compare
